<div id="player">
	<div id="jp_jplayer_1" class="jp-jplayer"></div>

	<div class="jp-audio">
		<div class="jp-type-single">
			<div id="jp_interface_1" class="jp-interface">
				<ul class="jp-controls">
					<li><a href="#" class="jp-play" tabindex="1">play</a></li>
					<li><a href="#" class="jp-pause" tabindex="1">pause</a></li>
					<li><a href="#" class="jp-stop" tabindex="1">stop</a></li>

					<li><a href="#" class="jp-mute" tabindex="1">mute</a></li>
					<li><a href="#" class="jp-unmute" tabindex="1">unmute</a></li>

					<li><a href="#" class="jp-next" tabindex="1">next</a></li>
				</ul>
				
				<div class="jp-progress">
					<div class="jp-seek-bar">
						<div class="jp-play-bar"></div>
					</div>
				</div>

				<div class="jp-volume-bar">
					<div class="jp-volume-bar-value"></div>
				</div>
				
				<div class="jp-current-time"></div>
				<div class="jp-duration"></div>
			</div>
			<div id="jp_playlist_1" class="jp-playlist">
				<ul>
					<li>{{ song.path }}</li>
				</ul>
			</div>
		</div>
	</div>
</div>


<div id="jplayerInspector"></div>


<div id="info" class="cf"></div>


<div id="decisions" class="cf"></div>



<script type="text/javascript">
var checkInterval;
var countFail = 0;
$(function()
{
	$('#jplayerInspector').jPlayerInspector({jPlayer:$('#jp_jplayer_1')});

	$('#jp_jplayer_1').jPlayer(
	{
		solution			: 'html, flash',
		swfPath				: '/jQuery.jPlayer.2.1.0',
		supplied			: '{{ song.codec }}',
		preload				: 'auto',
		volume				: Math.max(0.50, {% if song.rating is null %}0{% else %}{{ (song.rating - 0.50) * 2 }}{% endif %}),
		idPrefix			: 'jp',
		wmode				: 'window',
		ready				: function(event)
		{
			console.log('player rdy');
			setMedia();
		},
		ended				: function(event)
		{
			document.title = 'Song ended';
			if ($('*:focus').length > 0) {
				$('#right').fadeOut(3000);
				$('#decisions').fadeOut(400, function()
				{
					$('#info').fadeOut(400, function()
					{
						loadNextSong();
					});
				});
			} else {
				loadNextSong();
			}
		},
	});
	
	
	// did media set?
	// having some trouble, so checking the loading at intervals to ensure loading/reloading
	checkInterval = setInterval(function()
	{
		console.log('interval');
		console.log($('#jp_jplayer_1').data("jPlayer").status);
		// currentTime | currentPercentAbsolute | currentPercentRelative
		
		if ($('#jp_jplayer_1').data("jPlayer").status.srcSet && $('#jp_jplayer_1').data("jPlayer").status.duration > 0) {
			console.log('interval check good');
			clearInterval(checkInterval);
			setInfo();
		} else {
			console.log('interval check bad');
			$('#jplayerInspector').show();
			countFail++;
			if (countFail >= 5) { 
				window.location.reload(); // alert('this is failing...');
				//$('#player').after('<p>setting media again</p>');
			} else {
				setMedia();
			}
		}
	}, 4000);
	
	// next
	$('.jp-next').click(function()
	{
		console.log('next');
		
		$("#jp_jplayer_1").jPlayer('playHead', 99).jPlayer('play');
	});
});


function setMedia()
{
	document.title = 'ready';
	console.log('setMedia');
	
	$('#jp_jplayer_1').jPlayer('setMedia',
	{
		{{ song.codec }}: "/audio/{{ song.path|raw }}"
	}).jPlayer('play');
}


function setInfo()
{
	console.log('setInfo');
	
	// load song details
	$('#right').load('{{ path('detail') }}', function()
	{
		//if ($('*:focus').length > 0) {
			$('#right').fadeIn(3000);
		//}
	});

	// load info
	$('#info').load('{{ path('info') }}');

	// update now playing
	$('#lastfmMsg').load('{{ path('lastfm_nowplaying') }}');

	// update fav song
	$('#lastfmFav').load('{{ path('lastfm_favsong') }}');
}


function loadNextSong()
{
	// scrobble
	document.title = 'scrobbling';
	$('#jp_playlist_1 ul').append('<li>Scrobbling...</li>');
	$.get('/lastfm/scrobble', function(data)
	{
		document.title = 'loading';
		$('#jp_playlist_1 ul').append('<li>' + data + '</li>');
		
		// load next
		$('#jp_playlist_1 ul').append('<li>Loading next song...</li>');
		$('#middle').load('{{ path('postplay') }}');
	});
}
</script>
